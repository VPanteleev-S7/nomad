{{!
  Copyright (c) HashiCorp, Inc.
  SPDX-License-Identifier: BUSL-1.1
~}}

<Hds::PageHeader class="variable-title" as |PH|>
  <PH.Title>{{this.model.path}}</PH.Title>
  <PH.IconTile @icon="file-text" />
  <PH.Actions>
    {{#unless this.isDeleting}}

    <Hds::Form::Toggle::Field
      @value="enable"
      {{keyboard-shortcut 
        label="Toggle View (JSON/List)"
        pattern=(array "j")
        action=(action this.toggleView)
      }}
      checked={{eq this.view "json"}}
      data-test-memory-toggle
      {{on "change" (action this.toggleView)}}
    as |F|>
      <F.Label>JSON</F.Label>
    </Hds::Form::Toggle::Field>

    <div
      {{keyboard-shortcut 
        label="Copy Variable"
        pattern=(array "c" "v")
        action=(action this.copyVariable)}}
    >
      <Hds::Copy::Button
        @text="Copy"
        @textToCopy={{stringify-object this.model.items}}
      />
    </div>

      {{#if (can "write variable" path=this.model.path namespace=this.model.namespace)}}
        <Hds::Button
          @icon="edit"
          @text="Edit"
          @color="secondary"
          @route="variables.variable.edit"
          @model={{this.model}}
          @query={{hash view=this.view}}
          data-test-edit-button
          {{autofocus}}
        />
      {{/if}}
    {{/unless}}

    {{#if (can "destroy variable" path=this.model.path namespace=this.model.namespace)}}
      <TwoStepButton
        data-test-delete-button
        @alignRight={{true}}
        @idleText="Delete"
        @cancelText="Cancel"
        @confirmText="Yes, delete"
        @confirmationMessage="Are you sure you want to delete this variable and all its items?"
        @awaitingConfirmation={{this.deleteVariableFile.isRunning}}
        @onConfirm={{perform this.deleteVariableFile}}
        @onPrompt={{this.onDeletePrompt}}
        @onCancel={{this.onDeleteCancel}}
      />
    {{/if}}
  </PH.Actions>
</Hds::PageHeader>

{{!-- <h1 class="variable-title title with-flex">
  <div>
    <FlightIcon @name="file-text" />
    {{this.model.path}}
      <CopyButton
        @inset={{true}}
        @compact={{true}}
        @clipboardText={{this.model.path}}
      />

    <Toggle
      {{keyboard-shortcut 
        label="Toggle View (JSON/List)"
        pattern=(array "j")
        action=(action this.toggleView)
      }}
      data-test-memory-toggle
      @isActive={{eq this.view "json"}}
      @onToggle={{action this.toggleView}}
      title="JSON"
    >JSON</Toggle>
  </div>
  <Hds::ButtonSet>
      {{#unless this.isDeleting}}
        {{#if (can "write variable" path=this.model.path namespace=this.model.namespace)}}
          <Hds::Link::Standalone
            @icon="edit"
            @text="Edit"
            @route="variables.variable.edit"
            @model={{this.model}}
            @query={{hash view=this.view}}
            data-test-edit-button
            {{autofocus}}
          />
        {{/if}}
      {{/unless}}

      {{#if (can "destroy variable" path=this.model.path namespace=this.model.namespace)}}
        <TwoStepButton
          data-test-delete-button
          @alignRight={{true}}
          @idleText="Delete"
          @cancelText="Cancel"
          @confirmText="Yes, delete"
          @confirmationMessage="Are you sure you want to delete this variable and all its items?"
          @awaitingConfirmation={{this.deleteVariableFile.isRunning}}
          @onConfirm={{perform this.deleteVariableFile}}
          @onPrompt={{this.onDeletePrompt}}
          @onCancel={{this.onDeleteCancel}}
        />
      {{/if}}
  </Hds::ButtonSet>
</h1> --}}

{{#if this.shouldShowLinkedEntities}}
  <VariableForm::RelatedEntities
    @job={{this.model.pathLinkedEntities.job}}
    @group={{this.model.pathLinkedEntities.group}}
    @task={{this.model.pathLinkedEntities.task}}
    @namespace={{or this.model.namespace "default"}}
  />
{{/if}}

{{#if (eq this.view "json")}}
  <div class="boxed-section">
    <div class="boxed-section-head">
      Key/Value Data
      <CopyButton
        class="pull-right"
        @compact={{true}}
        @border={{true}}
        @clipboardText={{stringify-object this.model.items}}
          />
    </div>
    <div class="boxed-section-body is-full-bleed">
      <JsonViewer @json={{this.model.items}} />
    </div>
  </div>
{{else}}
  <ListTable class="variable-items" @source={{this.sortedKeyValues}} @sortProperty={{this.sortProperty}} @sortDescending={{this.sortDescending}} as |t|>
    <t.head>
      <t.sort-by @prop="key">Key</t.sort-by>
      <t.sort-by @prop="value">Value</t.sort-by>
    </t.head>
    <t.body as |row|>
      <tr data-test-var={{row.model.key}}>
        <td>
          {{row.model.key}}
        </td>
        <td colspan="3" class="value-cell">
          <div>
            <CopyButton
              @compact={{true}}
              @clipboardText={{row.model.value}}
            />
            <button
              class="show-hide-values button is-borderless is-compact"
              type="button"
              {{on "click" (action this.toggleRowVisibility row.model)}}
              {{keyboard-shortcut 
                label="Toggle Variable Visibility"
                pattern=(array "v")
                action=(action this.toggleRowVisibility row.model)
              }}

            >
              <FlightIcon
                @name={{if row.model.isVisible "eye" "eye-off"}}
                @title={{if row.model.isVisible "Hide Value" "Show Value"}}
              />
            </button>

            {{#if row.model.isVisible}}
              <code>{{row.model.value}}</code>
            {{else}}
              ********
            {{/if}}
          </div>
        </td>
      </tr>
    </t.body>
  </ListTable>
{{/if}}
